{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Active Workout - {{ workout.title }}</title>
    <link rel="stylesheet" href="{% static 'apps/css/active_workout_style.css' %}">
</head>
<body>
<input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

<div class="session-header">
    <button class="exit-btn" onclick="showExitModal()">Exit</button>
    <div class="progress-counter">
        <span id="current">1</span> / <span id="total">{{ total_exercises }}</span>
    </div>
    <button class="menu-btn">☰</button>
</div>

<div class="exercise-content">
    <div class="exercise-image-container">
        <img src="{% static 'images/default_exercise.png' %}" alt="Exercise" class="exercise-image" id="exerciseImage">
    </div>
    <h2 class="exercise-name" id="exerciseName"></h2>

    <div class="timer-container" id="timerContainer" style="display:none;">
        <div class="timer-box">
            <div class="timer-display" id="timer">00:00</div>
            <div class="timer-label">Min</div>
        </div>
    </div>

    <div id="strengthDetails" style="display:none;">
        Set <span id="currentSet">1</span> / <span id="totalSets"></span> • <span id="repsCount"></span> Reps
    </div>
</div>

<div class="up-next-section" id="upNext" style="display:none;">
    <div class="up-next-label">Up Next</div>
    <div class="up-next-content">
        <img src="{% static 'images/default_exercise.png' %}" alt="Next" class="up-next-image" id="upNextImage">
        <div class="up-next-info">
            <div class="up-next-name" id="upNextName"></div>
            <div class="up-next-details" id="upNextDetails"></div>
        </div>
    </div>
</div>

<div class="action-buttons">
    <button class="pause-btn" id="pauseBtn" onclick="togglePause()">
        <span id="pauseIcon">⏸</span>
    </button>
    <button class="did-it-btn" id="didItBtn" onclick="completeExercise()">Did it</button>
</div>

<div class="rest-overlay" id="restOverlay">
    <div class="rest-title">Rest</div>
    <div class="set-complete-badge" id="setCompleteBadge">Set 1 Complete ✓</div>
    <div class="rest-timer-circle" onclick="skipRest()">
        <div class="rest-timer" id="restTimer">00:00</div>
        <div class="rest-skip-text">Tap to skip</div>
    </div>
    <div class="rest-up-next">
        <div class="rest-up-next-label">Next Up</div>
        <div class="rest-up-next-name" id="restUpNextName">Set 2</div>
    </div>
</div>

<!-- Exit Modal -->
<div class="exit-modal" id="exitModal">
    <div class="exit-modal-content">
        <h3>Finish Workout?</h3>
        <p>You did not complete all the exercises.</p>
        <div class="exit-modal-buttons">
            <button onclick="saveAndExit()">Save and Exit</button>
            <button onclick="exitWithoutSaving()">Exit without Saving</button>
            <button onclick="returnToWorkout()">Return</button>
        </div>
    </div>
</div>

<script>
    // Backend ma'lumotlari
    const workoutId = {{ workout.pk }};
    const totalExercises = {{ total_exercises }};
    const csrfToken = "{{ csrf_token }}";
    const exercises = {{ exercises|safe }};

    // Asosiy holatlar
    let currentExerciseIndex = 0;
    let currentSet = 1;
    let isPaused = false;
    let timerInterval = null;
    let restInterval = null;
    let timeLeft = 0;
    let exerciseStartTime = null;
    let totalCaloriesBurned = 0;
    let totalDurationSeconds = 0;
    let totalExercisesCompleted = 0;

    // Formatlangan vaqt
    const formatTime = (s) => {
        const m = Math.floor(s / 60);
        const sec = s % 60;
        return `${m.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
    };

    // Asosiy mashqni yuklash
    const loadExercise = (index) => {
        if (index >= exercises.length) return finishWorkout();
        const ex = exercises[index];
        currentExerciseIndex = index;
        currentSet = 1;

        document.getElementById('current').textContent = index + 1;
        document.getElementById('exerciseName').textContent = ex.name;
        document.getElementById('exerciseImage').src = ex.image || "{% static 'images/default_exercise.png' %}";

        const didBtn = document.getElementById('didItBtn');
        didBtn.classList.remove('completed');
        didBtn.disabled = false;

        clearInterval(timerInterval);
        document.getElementById('timerContainer').style.display = 'none';
        document.getElementById('strengthDetails').style.display = 'none';

        if (ex.type === 'cardio') {
            timeLeft = ex.duration_minutes * 60;
            document.getElementById('timerContainer').style.display = 'flex';
            updateTimer();
            timerInterval = setInterval(() => {
                if (!isPaused && timeLeft > 0) timeLeft--;
                updateTimer();
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    completeExercise(true);
                }
            }, 1000);
            didBtn.textContent = 'Did it';
        } else {
            document.getElementById('strengthDetails').style.display = 'block';
            document.getElementById('totalSets').textContent = ex.sets;
            document.getElementById('repsCount').textContent = ex.reps;
            didBtn.textContent = 'Set Done';
        }

        showUpNext(index);
        exerciseStartTime = Date.now();
    };

    const updateTimer = () => {
        document.getElementById('timer').textContent = formatTime(timeLeft);
    };

    const togglePause = () => {
        isPaused = !isPaused;
        document.getElementById('pauseIcon').textContent = isPaused ? '▶' : '⏸';
    };

    const completeExercise = (auto = false) => {
        const ex = exercises[currentExerciseIndex];
        const btn = document.getElementById('didItBtn');

        const durationSec = Math.floor((Date.now() - exerciseStartTime) / 1000);
        totalDurationSeconds += durationSec;
        totalCaloriesBurned += (durationSec / 60) * ex.calories_per_minute;
        totalExercisesCompleted += 1;

        if (ex.type === 'strength' && currentSet < ex.sets) {
            startRest(ex.rest_seconds, currentSet, ex.sets);
            currentSet++;
            return;
        }

        btn.classList.add('completed');
        btn.textContent = '✓ Done';
        btn.disabled = true;
        setTimeout(() => loadExercise(currentExerciseIndex + 1), 800);
    };

    const startRest = (restSec, completedSet, totalSets) => {
        document.getElementById('setCompleteBadge').textContent = `Set ${completedSet} Complete ✓`;
        const next = exercises[currentExerciseIndex + 1];
        const nextText = next ? next.name : "Mashg'ulot yakunlanmoqda";
        document.getElementById('restUpNextName').textContent = nextText;
        document.getElementById('restOverlay').classList.add('active');

        let restLeft = restSec;
        document.getElementById('restTimer').textContent = formatTime(restLeft);
        restInterval = setInterval(() => {
            if (!isPaused && restLeft > 0) restLeft--;
            document.getElementById('restTimer').textContent = formatTime(restLeft);
            if (restLeft <= 0) skipRest();
        }, 1000);
    };

    const skipRest = () => {
        clearInterval(restInterval);
        document.getElementById('restOverlay').classList.remove('active');
        const ex = exercises[currentExerciseIndex];
        if (ex.type === 'strength' && currentSet <= ex.sets) {
            document.getElementById('currentSet').textContent = currentSet;
        } else {
            loadExercise(currentExerciseIndex + 1);
        }
    };

    const showUpNext = (index) => {
        const upNext = document.getElementById('upNext');
        const ex = exercises[index];

        if (ex.type === 'strength' && currentSet < ex.sets) {
            upNext.style.display = 'block';
            document.getElementById('upNextImage').src = ex.image || "{% static 'images/default_exercise.png' %}";
            document.getElementById('upNextName').textContent = ex.name;
            document.getElementById('upNextDetails').textContent = `Next: Set ${currentSet + 1}/${ex.sets}`;
            return;
        }

        if (index < exercises.length - 1) {
            const next = exercises[index + 1];
            upNext.style.display = 'block';
            document.getElementById('upNextImage').src = next.image || "{% static 'images/default_exercise.png' %}";
            document.getElementById('upNextName').textContent = next.name;
            document.getElementById('upNextDetails').textContent = next.type === 'cardio'
                ? `${next.duration_minutes} min`
                : `${next.sets} sets × ${next.reps} reps`;
        } else {
            upNext.style.display = 'none';
        }
    };

    // Exit logic
    const showExitModal = () => {
        document.getElementById('exitModal').classList.add('active');
        if (!isPaused) togglePause();
    };

    const returnToWorkout = () => {
        document.getElementById('exitModal').classList.remove('active');
        if (isPaused) togglePause();
    };

    const createForm = (save, action) => {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = action === 'complete'
            ? "{% url 'workout_complete' workout.id %}"
            : "{% url 'workout_start' workout.id %}";

        const fields = {
            csrfmiddlewaretoken: csrfToken,
            action: action,
            save_progress: save ? 'true' : 'false',
            total_duration: totalDurationSeconds,
            total_calories: totalCaloriesBurned.toFixed(2),
            exercises_completed: totalExercisesCompleted,
        };

        if (action === 'exit' && save) {
            fields.current_exercise_index = currentExerciseIndex;
        }

        Object.entries(fields).forEach(([name, value]) => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = name;
            input.value = value;
            form.appendChild(input);
        });

        return form;
    };

    const finishWorkout = () => {
        document.body.appendChild(createForm(true, 'complete'));
        document.forms[document.forms.length - 1].submit();
    };

    const saveAndExit = () => {
        document.body.appendChild(createForm(true, 'exit'));
        document.forms[document.forms.length - 1].submit();
    };

    const exitWithoutSaving = () => {
        document.body.appendChild(createForm(false, 'exit'));
        document.forms[document.forms.length - 1].submit();
    };

    document.addEventListener('DOMContentLoaded', () => loadExercise(0));
</script>
</body>
</html>