{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Active Workout - {{ workout.title }}</title>
    <link rel="stylesheet" href="{% static 'apps/style/active_workout_style.css' %}">
</head>
<body>
{% csrf_token %}

<div class="session-header">
    <button class="exit-btn" onclick="showExitModal()">Exit</button>
    <div class="progress-counter">
        <span id="current">1</span> / <span id="total">{{ total_exercises }}</span>
    </div>
    <button class="menu-btn">☰</button>
</div>

<div class="exercise-content">
    <div class="exercise-image-container">
        <img src="{% static 'images/default_exercise.png' %}" alt="Exercise" class="exercise-image" id="exerciseImage">
    </div>
    <h2 class="exercise-name" id="exerciseName"></h2>

    <div class="timer-container" id="timerContainer">
        <div class="timer-box">
            <div class="timer-display" id="timer">00:00</div>
            <div class="timer-label">Min</div>
        </div>
    </div>

    <div id="strengthDetails" style="display:none;">
        Set <span id="currentSet">1</span> / <span id="totalSets"></span> • <span id="repsCount"></span> Reps
    </div>
</div>

<div class="up-next-section" id="upNext">
    <div class="up-next-label">Up Next</div>
    <div class="up-next-content">
        <img src="{% static 'images/default_exercise.png' %}" alt="Next" class="up-next-image" id="upNextImage">
        <div class="up-next-info">
            <div class="up-next-name" id="upNextName"></div>
            <div class="up-next-details" id="upNextDetails"></div>
        </div>
    </div>
</div>

<div class="action-buttons">
    <button class="pause-btn" id="pauseBtn" onclick="togglePause()">
        <span id="pauseIcon">⏸</span>
    </button>
    <button class="did-it-btn" id="didItBtn" onclick="completeExercise()">Did it</button>
</div>

<div class="rest-overlay" id="restOverlay">
    <div class="rest-title">Rest</div>
    <div class="set-complete-badge" id="setCompleteBadge">Set 1 Complete ✓</div>
    <div class="rest-timer-circle" onclick="skipRest()">
        <div class="rest-timer" id="restTimer">00:00</div>
        <div class="rest-skip-text">Tap to skip</div>
    </div>
    <div class="rest-up-next">
        <div class="rest-up-next-label">Next Up</div>
        <div class="rest-up-next-name" id="restUpNextName">Set 2</div>
    </div>
</div>

<div class="exit-modal" id="exitModal">
    <div class="exit-modal-content">
        <h3 class="exit-modal-title">Finish Workout?</h3>
        <div class="exit-modal-divider"></div>
        <p class="exit-modal-text">You did not complete all the exercises.</p>
        <div class="exit-modal-buttons">
            <button class="exit-modal-btn save-exit-btn" onclick="saveAndExit()">Save and Exit</button>
            <button class="exit-modal-btn no-save-btn" onclick="exitWithoutSaving()">Exit without Saving</button>
            <button class="exit-modal-btn return-btn" onclick="returnToWorkout()">Return to workout</button>
        </div>
    </div>
</div>

<script>
    // ==========================================
    // BACKEND INTEGRATION VARIABLES
    // ==========================================
    const workoutId = {{ workout.pk }};
    const totalExercises = {{ total_exercises }};
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;


    const exercises = [
        {% for ex in exercises %}
            {
                id: {{ ex.exercise_id }},
                name: "{{ ex.name|escapejs }}",
                image: {% if ex.image %}"{{ ex.image }}"{% else %}null{% endif %},
                type: "{{ ex.exercise_type|lower }}",
                duration_minutes: {{ ex.duration_minutes|default:0 }},
                calories_per_minute: {{ ex.calories_per_minute|default:10 }},
                sets: {{ ex.sets|default:1 }},
                reps: {{ ex.reps|default:10 }},
                rest_seconds: {{ ex.rest_seconds|default:60 }}
            }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];

    // ==========================================
    // STATE MANAGEMENT
    // ==========================================
    let currentExerciseIndex = 0;
    let currentSet = 1; // Strength mashqlar uchun set hisoblagich
    let isPaused = false;
    let timerInterval = null;
    let restInterval = null;
    let timeLeft = 0;
    let exerciseStartTime = null;

    let totalCaloriesBurned = 0;
    let totalDurationSeconds = 0;
    let totalExercisesCompleted = 0;

    // ==========================================
    // UTILITY FUNCTIONS
    // ==========================================
    function formatTime(totalSeconds) {
        const minutes = Math.floor(totalSeconds / 60);
        const seconds = totalSeconds % 60;
        return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    // ==========================================
    // MAIN LOGIC
    // ==========================================

    function loadExercise(index) {
        if (index >= exercises.length) {
            finishWorkout();
            return;
        }

        currentExerciseIndex = index;
        const ex = exercises[index];

        // UI ni yangilash
        document.getElementById('current').textContent = index + 1;
        document.getElementById('exerciseName').textContent = ex.name;

        const defaultImage = "{% static 'images/default_exercise.png' %}";
        document.getElementById('exerciseImage').src = ex.image || defaultImage;

        currentSet = 1; // Har yangi mashqda Set 1 dan boshlanadi
        const didBtn = document.getElementById('didItBtn');
        didBtn.classList.remove('completed');
        didBtn.disabled = false;

        // Timer/Set ma'lumotlarini tozalash
        clearInterval(timerInterval);
        document.getElementById('timerContainer').style.display = 'none';
        document.getElementById('strengthDetails').style.display = 'none';


        if (ex.type === 'cardio') {
            showCardioInterface(ex.duration_minutes);
            didBtn.textContent = 'Did it';
        } else if (ex.type === 'strength') {
            showStrengthInterface(ex.sets, ex.reps);
            didBtn.textContent = 'Set Done';
        }

        showUpNext(index);
        exerciseStartTime = Date.now();
    }

    function showCardioInterface(minutes) {
        document.getElementById('timerContainer').style.display = 'flex';
        timeLeft = minutes * 60;
        updateTimerDisplay();
        startTimer();
    }

    function showStrengthInterface(sets, reps) {
        document.getElementById('strengthDetails').style.display = 'inline-block';
        document.getElementById('totalSets').textContent = sets;
        document.getElementById('repsCount').textContent = reps;
        document.getElementById('currentSet').textContent = currentSet;
        clearInterval(timerInterval);
    }

    function startTimer() {
        clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            if (!isPaused) {
                timeLeft = Math.max(0, timeLeft - 1);
                updateTimerDisplay();
            }
            if (timeLeft === 0) {
                clearInterval(timerInterval);
                completeExercise(true); // Cardio: vaqt tugasa avtomatik tugatish
            }
        }, 1000);
    }

    function updateTimerDisplay() {
        document.getElementById('timer').textContent = formatTime(timeLeft);
    }

    function togglePause() {
        isPaused = !isPaused;
        document.getElementById('pauseIcon').textContent = isPaused ? '▶' : '⏸';
    }

    function completeExercise(isAutoCompleted = false) {
        const ex = exercises[currentExerciseIndex];
        const btn = document.getElementById('didItBtn');

        if (ex.type === 'cardio') {
            processExerciseCompletion(ex);
            clearInterval(timerInterval);
            btn.classList.add('completed');
            btn.textContent = '✓ Done';
            btn.disabled = true;

            totalExercisesCompleted++;

            setTimeout(() => { loadExercise(currentExerciseIndex + 1); }, 800);

        } else if (ex.type === 'strength') {
            // Strength: Set mantiqi
            if (currentSet < ex.sets) {
                // Setni yakunlash va rest berish
                startRest(ex.rest_seconds, currentSet, ex.sets);
                currentSet++; // Keyingi Set ga o'tish
            } else {
                // Barcha Setlar tugadi, mashqni yakunlash
                processExerciseCompletion(ex);
                btn.classList.add('completed');
                btn.textContent = '✓ Done';
                btn.disabled = true;

                totalExercisesCompleted++;

                setTimeout(() => { loadExercise(currentExerciseIndex + 1); }, 800);
            }
        }
    }

    function processExerciseCompletion(ex) {
        const duration = Date.now() - exerciseStartTime;
        const exerciseDuration = Math.floor(duration / 1000);
        totalDurationSeconds += exerciseDuration;

        if (ex.calories_per_minute) {
            const caloriesBurned = (exerciseDuration / 60) * ex.calories_per_minute;
            totalCaloriesBurned += caloriesBurned;
        }
    }

    function startRest(restSeconds, completedSet, totalSets) {
        document.getElementById('setCompleteBadge').textContent = `Set ${completedSet} Complete ✓`;

        const nextSet = completedSet + 1;

        // Keyingi Set yoki Keyingi Mashq (agar setlar tugasa)
        const nextExercise = exercises[currentExerciseIndex + 1];

        if(nextSet <= totalSets){
            document.getElementById('restUpNextName').textContent = `Set ${nextSet} / ${totalSets}`;
        } else if (nextExercise) {
            document.getElementById('restUpNextName').textContent = `Keyingi Mashq: ${nextExercise.name}`;
        } else {
            document.getElementById('restUpNextName').textContent = "Mashg'ulot yakunlanmoqda";
        }

        document.getElementById('restOverlay').classList.add('active');

        let restLeft = restSeconds;
        document.getElementById('restTimer').textContent = formatTime(restLeft);

        clearInterval(restInterval);
        restInterval = setInterval(() => {
            if (!isPaused) {
                restLeft = Math.max(0, restLeft - 1);
                document.getElementById('restTimer').textContent = formatTime(restLeft);
            }
            if (restLeft <= 0) {
                skipRest();
            }
        }, 1000);
    }

    function skipRest() {
        clearInterval(restInterval);
        document.getElementById('restOverlay').classList.remove('active');
        const ex = exercises[currentExerciseIndex];

        if (ex.type === 'strength' && currentSet <= ex.sets) {
            // Agar rest tugagan bo'lsa, lekin hali setlar qolgan bo'lsa
            showStrengthInterface(ex.sets, ex.reps);
        } else {
            // Agar rest tugasa va setlar tugagan bo'lsa (yoki cardio bo'lsa, lekin bu yerda bo'lmaydi)
            loadExercise(currentExerciseIndex + 1);
        }
    }

    function showUpNext(index) {
        const upNextSection = document.getElementById('upNext');
        upNextSection.style.display = 'none';
        const ex = exercises[index];

        // 1. Agar Strength mashq bo'lsa va hali Setlar qolgan bo'lsa
        if (ex.type === 'strength' && currentSet < ex.sets) {
            upNextSection.style.display = 'block';
            document.getElementById('upNextName').textContent = ex.name;
            document.getElementById('upNextDetails').textContent = `Next: Set ${currentSet + 1}/${ex.sets}`;
            document.getElementById('upNextImage').src = ex.image || "{% static 'images/default_exercise.png' %}";
            return;
        }

        // 2. Keyingi mashqni ko'rsatish (agar mavjud bo'lsa)
        if (index < exercises.length - 1) {
            const next = exercises[index + 1];
            upNextSection.style.display = 'block';
            document.getElementById('upNextImage').src = next.image || "{% static 'images/default_exercise.png' %}";
            document.getElementById('upNextName').textContent = next.name;

            if (next.type === 'cardio') {
                document.getElementById('upNextDetails').textContent = `${next.duration_minutes} min`;
            } else {
                document.getElementById('upNextDetails').textContent = `${next.sets} sets × ${next.reps} reps`;
            }
        } else {
            upNextSection.style.display = 'none';
        }
    }

    // ==========================================
    // MODAL/EXIT LOGIC
    // ==========================================
    function showExitModal() {
        document.getElementById('exitModal').classList.add('active');
        if (!isPaused) togglePause();
    }

    function returnToWorkout() {
        document.getElementById('exitModal').classList.remove('active');
        if (isPaused) togglePause();
    }

    function finishWorkout() {
        const form = createExitForm(true, 'complete');
        document.body.appendChild(form);
        form.submit();
    }

    function saveAndExit() {
        const form = createExitForm(true, 'exit');
        document.body.appendChild(form);
        form.submit();
    }

    function exitWithoutSaving() {
        const form = createExitForm(false, 'exit');
        document.body.appendChild(form);
        form.submit();
    }

    function createExitForm(save, action) {
        const form = document.createElement('form');
        form.method = 'POST';
        // 'workout_start' URL nomini Django urls.py da tekshiring
        form.action = "{% url 'workout_start' workout.id %}";

        // CSRF Token
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = csrfToken;
        form.appendChild(csrfInput);

        // Action
        const actionInput = document.createElement('input');
        actionInput.type = 'hidden';
        actionInput.name = 'action';
        actionInput.value = action;
        form.appendChild(actionInput);

        // Save Progress
        const saveInput = document.createElement('input');
        saveInput.type = 'hidden';
        saveInput.name = 'save_progress';
        saveInput.value = save ? 'true' : 'false';
        form.appendChild(saveInput);

        // Natijalar
        const durationInput = document.createElement('input');
        durationInput.type = 'hidden';
        durationInput.name = 'total_duration';
        durationInput.value = totalDurationSeconds;
        form.appendChild(durationInput);

        const caloriesInput = document.createElement('input');
        caloriesInput.type = 'hidden';
        caloriesInput.name = 'total_calories';
        caloriesInput.value = totalCaloriesBurned.toFixed(2);
        form.appendChild(caloriesInput);

        const completedInput = document.createElement('input');
        completedInput.type = 'hidden';
        completedInput.name = 'exercises_completed';
        completedInput.value = totalExercisesCompleted;
        form.appendChild(completedInput);

        // Joriy index
        if (action === 'exit' && save) {
            const indexInput = document.createElement('input');
            indexInput.type = 'hidden';
            indexInput.name = 'current_exercise_index';
            indexInput.value = currentExerciseIndex;
            form.appendChild(indexInput);
        }

        return form;
    }

    // ==========================================
    // INITIALIZATION
    // ==========================================
    document.addEventListener('DOMContentLoaded', () => {
        loadExercise(0);
    });
</script>
</body>
</html>