<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Fitness Questionnaire</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #2c3e50;
            color: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .container {
            flex: 1;
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
            width: 100%;
        }

        .progress-bar {
            height: 6px;
            background: #34495e;
            border-radius: 3px;
            margin-bottom: 30px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #f1c40f, #f39c12);
            transition: width 0.3s ease;
        }

        .question {
            display: none;
        }

        .question.active {
            display: block;
        }

        h1 {
            font-size: 28px;
            margin-bottom: 20px;
            text-align: center;
        }

        .subtitle {
            color: #f1c40f;
            text-align: center;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .option-btn {
            background: #f1c40f;
            color: #2c3e50;
            border: none;
            padding: 18px 20px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .option-btn:hover {
            background: #f39c12;
            transform: translateY(-2px);
        }

        .option-btn.selected {
            background: #2ecc71;
            color: white;
        }

        .option-btn.outline {
            background: transparent;
            border: 2px solid #f1c40f;
            color: #f1c40f;
        }

        .option-btn.outline.selected {
            background: #f1c40f;
            color: #2c3e50;
        }

        .weight-input {
            background: #34495e;
            border: none;
            padding: 15px;
            border-radius: 8px;
            color: white;
            font-size: 48px;
            text-align: center;
            margin: 30px 0;
        }

        .unit {
            text-align: center;
            color: #95a5a6;
            margin-bottom: 20px;
        }

        .final-screen {
            text-align: center;
            padding: 40px 20px;
        }

        .badge {
            width: 200px;
            height: 200px;
            margin: 30px auto;
            border: 4px solid #f1c40f;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .badge h2 {
            font-size: 24px;
            color: #f1c40f;
            text-transform: uppercase;
        }

        .stats {
            font-size: 36px;
            font-weight: bold;
            color: #f1c40f;
            margin: 20px 0;
        }

        .continue-btn {
            background: #f1c40f;
            color: #2c3e50;
            border: none;
            padding: 18px 40px;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
        }
    </style>
</head>
<body>
<div class="container">
    <!-- Progress Bar -->
    <div class="progress-bar">
        <div class="progress-fill" id="progress"></div>
    </div>

    <!-- Question 1: Gender -->
    <div class="question active" data-step="1">
        <h1>Let's start with the basics</h1>
        <div class="options">
            <button class="option-btn" onclick="selectOption('gender', 'male')">Male</button>
            <button class="option-btn" onclick="selectOption('gender', 'female')">Female</button>
        </div>
    </div>

    <!-- Question 2: Experience -->
    <div class="question" data-step="2">
        <h1>How would you describe your gym experience?</h1>
        <div class="options">
            <button class="option-btn" onclick="selectOption('experience', 'beginner')">
                Beginner<br><small>Training for less than 6 mos</small>
            </button>
            <button class="option-btn" onclick="selectOption('experience', 'intermediate')">
                Intermediate<br><small>Training for 6 mos - 2 yrs</small>
            </button>
            <button class="option-btn" onclick="selectOption('experience', 'advanced')">
                Advanced<br><small>Training for more than 2 yrs</small>
            </button>
        </div>
    </div>

    <!-- Question 3: Goal -->
    <div class="question" data-step="3">
        <h1>What's your current fitness objective?</h1>
        <div class="options">
            <button class="option-btn" onclick="selectOption('goal', 'build_body')">Build a great body</button>
            <button class="option-btn" onclick="selectOption('goal', 'lose_weight')">Lose weight</button>
            <button class="option-btn" onclick="selectOption('goal', 'gain_muscle')">Gain muscle</button>
            <button class="option-btn" onclick="selectOption('goal', 'get_shape')">Get in shape</button>
        </div>
    </div>

    <!-- Question 4: Motivation (Multi-select) -->
    <div class="question" data-step="4">
        <h1>What drives you most to work out?</h1>
        <p class="subtitle">You can choose more than one</p>
        <div class="options">
            <button class="option-btn outline" onclick="toggleOption('motivation', 'healthy_lifestyle')">
                I want a healthy lifestyle
            </button>
            <button class="option-btn outline" onclick="toggleOption('motivation', 'improve_physique')">
                Improve my physique
            </button>
            <button class="option-btn outline" onclick="toggleOption('motivation', 'get_stronger')">
                Get stronger every day
            </button>
            <button class="option-btn outline" onclick="toggleOption('motivation', 'good_challenge')">
                I like a good challenge
            </button>
        </div>
        <button class="option-btn" onclick="continueToNext()" style="margin-top: 30px;">Continue</button>
    </div>

    <!-- Question 5: Days per week -->
    <div class="question" data-step="5">
        <h1>How many days per week would you like to work out?</h1>
        <div class="options">
            <button class="option-btn" onclick="selectOption('days', '2')">2 days</button>
            <button class="option-btn" onclick="selectOption('days', '3')">3 days</button>
            <button class="option-btn" onclick="selectOption('days', '4')">4 days</button>
        </div>
    </div>

    <!-- Question 6: Weight -->
    <div class="question" data-step="6">
        <h1>What's your weight?</h1>
        <input type="number" class="weight-input" id="weight" placeholder="63" value="63" min="30" max="200">
        <div class="unit">Kilograms</div>
        <button class="option-btn" onclick="selectOption('weight', document.getElementById('weight').value)">
            Next
        </button>
    </div>

    <!-- Final Screen -->
    <div class="question" data-step="7">
        <div class="final-screen">
            <h1>Ready to crush your goal?</h1>
            <div class="badge">
                <h2 id="finalGoal">BUILD A<br>GREAT BODY</h2>
            </div>
            <div class="stats">15,227,894</div>
            <p>Users just like you match your profile, and reach their goal!</p>
            <button class="continue-btn" onclick="submitQuestionnaire()">Build My Plan</button>
        </div>
    </div>
</div>

<div id="debug"
     style="white-space: pre-wrap; background:#1e272e; color:#f5f6fa; padding:15px; margin-top:20px; border-radius:8px; display:none;">
</div>

<script>
    // Telegram WebApp
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();

    console.log('üîç Telegram WebApp initialized');
    console.log('üì± Platform:', tg.platform);
    console.log('üåê Version:', tg.version);

    // Get Telegram user ma'lumotlari (multiple methods)
    let telegramUser = null;
    let telegram_id = null;
    let first_name = 'User';
    let last_name = '';
    let username = '';
    let photo_url = '';

    // Method 1: initDataUnsafe
    if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
        telegramUser = tg.initDataUnsafe.user;
        telegram_id = telegramUser.id;
        first_name = telegramUser.first_name || 'User';
        last_name = telegramUser.last_name || '';
        username = telegramUser.username || '';
        photo_url = telegramUser.photo_url || '';

        console.log('‚úÖ Method 1: Got user from initDataUnsafe');
        console.log('üë§ User:', telegramUser);
    }

    // Method 2: Parse initData manually
    if (!telegram_id && tg.initData) {
        console.log('üîÑ Trying Method 2: Parsing initData manually');
        try {
            const params = new URLSearchParams(tg.initData);
            const userParam = params.get('user');
            if (userParam) {
                telegramUser = JSON.parse(decodeURIComponent(userParam));
                telegram_id = telegramUser.id;
                first_name = telegramUser.first_name || 'User';
                last_name = telegramUser.last_name || '';
                username = telegramUser.username || '';
                photo_url = telegramUser.photo_url || '';

                console.log('‚úÖ Method 2: Parsed user from initData');
                console.log('üë§ User:', telegramUser);
            }
        } catch (e) {
            console.error('‚ùå Failed to parse initData:', e);
        }
    }

    // Final check
    console.log('=' * 60);
    console.log('FINAL USER DATA:');
    console.log('ID:', telegram_id);
    console.log('Name:', first_name, last_name);
    console.log('Username:', username);
    console.log('Photo:', photo_url);
    console.log('=' * 60);

    // Form data
    const formData = {
        telegram_id: telegram_id,
        first_name: first_name,
        last_name: last_name,
        username: username,
        photo_url: photo_url,
        gender: '',
        experience: '',
        goal: '',
        motivation: [],
        days: '',
        weight: 63
    };

    let currentStep = 1;
    const totalSteps = 7;

    // Update progress
    function updateProgress() {
        const progress = (currentStep / totalSteps) * 100;
        document.getElementById('progress').style.width = progress + '%';
    }

    // Select option (single choice)
    function selectOption(field, value) {
        formData[field] = value;

        if (field === 'goal') {
            document.getElementById('finalGoal').textContent =
                value.replace('_', ' ').toUpperCase();
        }

        nextStep();
    }

    // Toggle option (multi-choice)
    function toggleOption(field, value) {
        const btn = event.target;

        if (formData[field].includes(value)) {
            formData[field] = formData[field].filter(v => v !== value);
            btn.classList.remove('selected');
        } else {
            formData[field].push(value);
            btn.classList.add('selected');
        }
    }

    // Continue to next (for multi-choice)
    function continueToNext() {
        if (formData.motivation.length === 0) {
            tg.showAlert('Please select at least one option');
            return;
        }
        nextStep();
    }

    // Next step
    function nextStep() {
        document.querySelector('.question.active').classList.remove('active');
        currentStep++;
        document.querySelector(`.question[data-step="${currentStep}"]`).classList.add('active');
        updateProgress();
    }

    // Submit questionnaire
    async function submitQuestionnaire() {
        console.log('üì§ Submitting data:', formData);

        // DEBUG PANELGA YOZISH
        const dbg = document.getElementById('debug');
        dbg.style.display = "block";

        dbg.textContent =
            "üìå FORM DATA:\n" +
            JSON.stringify(formData, null, 2) +
            "\n\nüìå tg.initData:\n" +
            tg.initData +
            "\n\nüìå tg.initDataUnsafe.user:\n" +
            JSON.stringify(tg.initDataUnsafe.user, null, 2);

        // Validate Telegram ID
        if (!formData.telegram_id) {
            tg.showAlert('Error: Telegram ID not found. Please restart the bot.');
            return;
        }

        // Show loading
        tg.MainButton.setText('Submitting...');
        tg.MainButton.showProgress();

        try {
            const response = await fetch('/api/questionnaire/submit/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            });

            console.log('üì° Response status:', response.status);

            const data = await response.json();
            console.log('üì¶ Response data:', data);

            tg.MainButton.hideProgress();

            if (data.success) {
                console.log('‚úÖ Success! Redirecting...');
                // Redirect to workouts page
                window.location.href = '';
            } else {
                console.error('‚ùå Error:', data.error);
                tg.showAlert('Error: ' + (data.error || 'Unknown error'));
            }
        } catch (error) {
            console.error('‚ùå Network error:', error);
            tg.MainButton.hideProgress();
            tg.showAlert('Connection error. Please try again.');
        }
    }

    // Initialize
    updateProgress();

    // Show user info for debugging
    if (telegram_id) {
        console.log('‚úÖ Ready to start onboarding!');
        console.log('User ID:', telegram_id);
    } else {
        console.error('‚ùå WARNING: No Telegram ID available!');
    }
</script>
</body>
</html>